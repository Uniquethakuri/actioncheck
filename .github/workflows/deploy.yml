name: Deploy Laravel to cPanel

on:
  push:
    branches:
      - main  # Trigger deployment on pushes to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Enable Debug Mode
      run: set -x  # Enable debug mode to print each command as it runs for easier troubleshooting

    - name: Set up SSH
      env:
        SSH_KEY: ${{ secrets.CPANEL_SSH_KEY }}
      run: |
        # Step 1: Create SSH directory
        mkdir -p ~/.ssh
        echo "Created .ssh directory"

        # Step 2: Add SSH private key
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        echo "Added SSH private key to .ssh/id_rsa"
        
        # Step 3: Set permissions for SSH private key
        chmod 600 ~/.ssh/id_rsa
        echo "Set permissions for SSH private key"

        # Step 4: Verify the contents of the SSH directory
        ls -la ~/.ssh

        # Step 5: Verify the private key file is correctly written (remove this in production for security)
        cat ~/.ssh/id_rsa || echo "Failed to display the private key contents"

    - name: Debug CPANEL_HOST
      run: echo "cPanel Host: ${{ secrets.CPANEL_HOST }}"

    - name: Test Connectivity to cPanel Host
      run: |
        echo "Testing connectivity to ${{ secrets.CPANEL_HOST }}"
        ping -c 4 ${{ secrets.CPANEL_HOST }} || echo "Ping failed"
      continue-on-error: true  # Allow the workflow to continue even if ping fails for debugging

    - name: Attempt to Add cPanel Host to known_hosts
      run: |
        echo "Attempting to add ${{ secrets.CPANEL_HOST }} to known_hosts"
        ssh-keyscan -H ${{ secrets.CPANEL_HOST }} >> ~/.ssh/known_hosts || echo "ssh-keyscan failed"
      continue-on-error: true  # Allow the workflow to continue even if ssh-keyscan fails

    - name: Output known_hosts File
      run: |
        echo "Contents of known_hosts:"
        cat ~/.ssh/known_hosts || echo "known_hosts file is empty or not created"

    # Proceed with Deployment if previous steps are successful
    - name: Deploy to cPanel Server
      if: success()  # Run only if previous steps have succeeded
      env:
        CPANEL_HOST: ${{ secrets.CPANEL_HOST }}
        CPANEL_USERNAME: ${{ secrets.CPANEL_USERNAME }}
      run: |
        rsync -avz --exclude=".git" --exclude="node_modules" \
          -e "ssh -i ~/.ssh/id_rsa" \
          ./ $CPANEL_USERNAME@$CPANEL_HOST:/home/$CPANEL_USERNAME/public_html/
